#!/bin/bash
# fetch-cve-data.sh - Gather CVE data from multiple sources IN PARALLEL
# Usage: ./fetch-cve-data.sh CVE-XXXX-XXXXX [output-dir]

set -e

CVE_ID="${1:?Usage: $0 CVE-ID [output-dir]}"
OUTPUT_DIR="${2:-.}"

echo "=== Fetching data for $CVE_ID (parallel) ==="
echo ""

# Parse CVE ID components for CISA Vulnrichment path
YEAR=$(echo "$CVE_ID" | cut -d'-' -f2)
NUM=$(echo "$CVE_ID" | cut -d'-' -f3)
PREFIX="${NUM:0:2}xxx"

# Create temp files for parallel output
CISA_TMP=$(mktemp)
NVD_TMP=$(mktemp)
OVAL_TMP=$(mktemp)

cleanup() {
    rm -f "$CISA_TMP" "$NVD_TMP" "$OVAL_TMP"
}
trap cleanup EXIT

# ============================================
# PARALLEL FETCH: Run all three fetches simultaneously
# ============================================

echo "[PARALLEL] Fetching from CISA Vulnrichment, NVD, and Azure Linux OVAL..."

# 1. CISA Vulnrichment (preferred - richer data)
(
    CISA_URL="https://raw.githubusercontent.com/cisagov/vulnrichment/develop/${YEAR}/${PREFIX}/${CVE_ID}.json"
    CISA_FILE="$OUTPUT_DIR/${CVE_ID}-cisa.json"
    
    if curl -sf "$CISA_URL" -o "$CISA_FILE" 2>/dev/null; then
        echo "CISA:OK" > "$CISA_TMP"
    else
        echo "CISA:NOTFOUND" > "$CISA_TMP"
    fi
) &
PID_CISA=$!

# 2. NVD API (fallback/additional references)
(
    NVD_FILE="$OUTPUT_DIR/${CVE_ID}-nvd.json"
    curl -s "https://services.nvd.nist.gov/rest/json/cves/2.0?cveId=$CVE_ID" -o "$NVD_FILE"
    
    if jq -e '.vulnerabilities[0]' "$NVD_FILE" > /dev/null 2>&1; then
        echo "NVD:OK" > "$NVD_TMP"
    else
        echo "NVD:NOTFOUND" > "$NVD_TMP"
    fi
) &
PID_NVD=$!

# 3. Azure Linux OVAL
(
    OVAL_FILE="$OUTPUT_DIR/azurelinux-3.0-oval.xml"
    if [ ! -f "$OVAL_FILE" ]; then
        curl -sL "https://raw.githubusercontent.com/microsoft/AzureLinuxVulnerabilityData/main/azurelinux-3.0-oval.xml" -o "$OVAL_FILE"
    fi
    
    if grep -q "ref_id=\"$CVE_ID\"" "$OVAL_FILE" 2>/dev/null; then
        echo "OVAL:OK" > "$OVAL_TMP"
    else
        echo "OVAL:NOTFOUND" > "$OVAL_TMP"
    fi
) &
PID_OVAL=$!

# Wait for all parallel fetches to complete
wait $PID_CISA $PID_NVD $PID_OVAL

echo ""
echo "=== Results ==="
echo ""

# ============================================
# PROCESS CISA VULNRICHMENT (Preferred source)
# ============================================
echo "[1/3] CISA Vulnrichment:"
CISA_FILE="$OUTPUT_DIR/${CVE_ID}-cisa.json"

if [ "$(cat "$CISA_TMP")" = "CISA:OK" ]; then
    echo "  ✓ Found enriched CVE data"
    echo ""
    echo "  SSVC Decision Points:"
    jq -r '.containers.adp[0].metrics[0].other.content.options[] | "    - " + (to_entries[0] | "\(.key): \(.value)")' "$CISA_FILE" 2>/dev/null || echo "    (not available)"
    echo ""
    echo "  CWE:"
    jq -r '.containers.cna.problemTypes[0].descriptions[0] | "    \(.cweId): \(.description)"' "$CISA_FILE" 2>/dev/null || echo "    (not available)"
    echo ""
    echo "  CVSS 3.1:"
    jq -r '.containers.cna.metrics[0].cvssV3_1 | "    Score: \(.baseScore) (\(.baseSeverity))\n    Vector: \(.vectorString)"' "$CISA_FILE" 2>/dev/null || echo "    (not available)"
    echo ""
    echo "  Affected Products:"
    jq -r '.containers.cna.affected[] | "    - \(.vendor)/\(.product) < \(.versions[0].lessThan)"' "$CISA_FILE" 2>/dev/null || echo "    (not available)"
    echo ""
    echo "  References:"
    jq -r '.containers.cna.references[].url | "    - \(.)"' "$CISA_FILE" 2>/dev/null || echo "    (none)"
else
    echo "  ✗ Not found in CISA Vulnrichment (may not be enriched yet)"
fi

# ============================================
# PROCESS NVD DATA
# ============================================
echo ""
echo "[2/3] NVD:"
NVD_FILE="$OUTPUT_DIR/${CVE_ID}-nvd.json"

if [ "$(cat "$NVD_TMP")" = "NVD:OK" ]; then
    echo "  ✓ Found in NVD"
    echo ""
    echo "  Summary:"
    jq -r '.vulnerabilities[0].cve | "    Published: \(.published)\n    Severity: \((.metrics.cvssMetricV31[0].cvssData.baseSeverity // .metrics.cvssMetricV30[0].cvssData.baseSeverity // "Unknown"))\n    Score: \((.metrics.cvssMetricV31[0].cvssData.baseScore // .metrics.cvssMetricV30[0].cvssData.baseScore // "N/A"))"' "$NVD_FILE"
    echo ""
    echo "  References (mine these for fix commits):"
    jq -r '.vulnerabilities[0].cve.references[] | "    - \(.url)\n      Tags: \(.tags // [] | join(", "))"' "$NVD_FILE" | head -20
else
    echo "  ✗ Not found in NVD"
fi

# ============================================
# PROCESS OVAL DATA
# ============================================
echo ""
echo "[3/3] Azure Linux OVAL:"
OVAL_FILE="$OUTPUT_DIR/azurelinux-3.0-oval.xml"

if [ "$(cat "$OVAL_TMP")" = "OVAL:OK" ]; then
    echo "  ✓ Found in Azure Linux 3.0"
    echo ""
    # Extract all affected packages
    PACKAGES=$(grep -B 5 "ref_id=\"$CVE_ID\"" "$OVAL_FILE" | grep -oP 'package \K[a-z0-9_-]+(?= for)' | sort -u)
    echo "  Affected package(s): $PACKAGES"
    echo "$PACKAGES" > "$OUTPUT_DIR/${CVE_ID}-packages.txt"
    echo ""
    grep -B 5 -A 15 "ref_id=\"$CVE_ID\"" "$OVAL_FILE" | head -30 | sed 's/^/    /'
else
    echo "  ✗ Not found in Azure Linux 3.0 OVAL"
fi

echo ""
echo "=== Next Steps ==="
echo "  1. Review references above for upstream fix commits"
echo "  2. For each package, run: ./find-package-spec.sh <package> $CVE_ID"
echo "  3. Compare Azure Linux patches to upstream: ./compare-patches.sh <patch> <upstream-url>"
echo ""
echo "Files saved to $OUTPUT_DIR:"
ls -la "$OUTPUT_DIR"/${CVE_ID}*.json "$OUTPUT_DIR"/${CVE_ID}*.txt 2>/dev/null | sed 's/^/  /' || echo "  (none)"
