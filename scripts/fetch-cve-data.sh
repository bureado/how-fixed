#!/bin/bash
# fetch-cve-data.sh - Gather CVE data from multiple sources
# Usage: ./fetch-cve-data.sh CVE-XXXX-XXXXX

set -e

CVE_ID="${1:?Usage: $0 CVE-ID}"
OUTPUT_DIR="${2:-.}"

echo "=== Fetching data for $CVE_ID ==="

# 1. NVD Data
echo "[1/4] Fetching NVD data..."
NVD_FILE="$OUTPUT_DIR/${CVE_ID}-nvd.json"
curl -s "https://services.nvd.nist.gov/rest/json/cves/2.0?cveId=$CVE_ID" > "$NVD_FILE"

if jq -e '.vulnerabilities[0]' "$NVD_FILE" > /dev/null 2>&1; then
    echo "  ✓ NVD data saved to $NVD_FILE"
    # Extract key info
    jq -r '.vulnerabilities[0].cve | {
        id: .id,
        published: .published,
        description: .descriptions[0].value,
        severity: (.metrics.cvssMetricV31[0].cvssData.baseSeverity // .metrics.cvssMetricV30[0].cvssData.baseSeverity // "Unknown")
    }' "$NVD_FILE"
else
    echo "  ✗ CVE not found in NVD"
fi

# 2. Azure Linux OVAL
echo "[2/4] Fetching Azure Linux OVAL data..."
OVAL_FILE="$OUTPUT_DIR/azurelinux-3.0-oval.xml"
if [ ! -f "$OVAL_FILE" ]; then
    curl -sL "https://raw.githubusercontent.com/microsoft/AzureLinuxVulnerabilityData/main/azurelinux-3.0-oval.xml" -o "$OVAL_FILE"
fi

echo "  Searching for $CVE_ID in OVAL..."
OVAL_MATCH=$(grep -A 15 "ref_id=\"$CVE_ID\"" "$OVAL_FILE" 2>/dev/null || true)
if [ -n "$OVAL_MATCH" ]; then
    echo "  ✓ Found in OVAL:"
    echo "$OVAL_MATCH" | head -20
else
    echo "  ✗ Not found in Azure Linux 3.0 OVAL (may not affect Azure Linux)"
fi

# 3. GitHub Advisory
echo "[3/4] Checking GitHub Advisory..."
GHSA_URL="https://github.com/advisories?query=$CVE_ID"
echo "  → Manual check: $GHSA_URL"

# 4. Azure Linux repo search
echo "[4/4] Searching Azure Linux commits..."
echo "  → Search URL: https://github.com/microsoft/azurelinux/search?q=$CVE_ID&type=commits"

echo ""
echo "=== Data collection complete ==="
echo "Files created in $OUTPUT_DIR:"
ls -la "$OUTPUT_DIR"/*.json "$OUTPUT_DIR"/*.xml 2>/dev/null || true
